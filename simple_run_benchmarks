#!/usr/bin/env bash

# Gives us $MASTERS env var
source ~/spark-ec2/ec2-variables.sh
command=~/graphx/run-example
class="org.apache.spark.graph.Analytics"
epart=128
algo=pagerank
data="soc-LiveJournal1.txt"
DATE=`date +%Y-%m-%d`
file=~/results/caching-$DATE
tc=/usr/bin/time
numtrials=5



# 5 iterations pagerank
iter=20
counter=0
partstrat="RandomVertexCut"
while [ $counter -lt $numtrials ]; do
  # echo "NEW RUN!!!!!" >> $file
  # ~/rebuild-graphx -no
  echo $command $class spark://$MASTERS:7077 $algo hdfs://$MASTERS:9000/$data --numIter=$iter --numEPart=$epart --partStrategy=$partstrat >> $file
  #{ time %e $command $class spark://$MASTERS:7077 $algo hdfs://$MASTERS:9000/$data --numIter=$iter --numEPart=$epart ; } 2> $file
  { $tc -f "TOTAL: %e seconds" $command $class spark://$MASTERS:7077 $algo hdfs://$MASTERS:9000/$data --numIter=$iter --numEPart=$epart --partStrategy=$partstrat; } 2>> $file
  echo "" >> $file
  counter=$(( $counter + 1 ))
done


# 10 iterations pagerank
# iter=10
# counter=0
# while [ $counter -lt $numtrials ]; do
#   # echo "NEW RUN!!!!!" >> $file
#   echo $command $class spark://$MASTERS:7077 $algo hdfs://$MASTERS:9000/$data --numIter=$iter --numEPart=$epart >> $file
#   #{ time %e $command $class spark://$MASTERS:7077 $algo hdfs://$MASTERS:9000/$data --numIter=$iter --numEPart=$epart ; } 2> $file
#   { $tc -f "TOTAL: %e seconds" $command $class spark://$MASTERS:7077 $algo hdfs://$MASTERS:9000/$data --numIter=$iter --numEPart=$epart; } 2>> $file
#   echo "" >> $file
#   counter=$(( $counter + 1 ))
# done


# 20 iterations pagerank
# iter=20 counter=0
# partstrat="RandomVertexCut"
# while [ $counter -lt $numtrials ]; do
#   # echo "NEW RUN!!!!!" >> $file
#   echo $command $class spark://$MASTERS:7077 $algo hdfs://$MASTERS:9000/$data --numIter=$iter --numEPart=$epart --partStrategy=$partstrat >> $file
#   #{ time %e $command $class spark://$MASTERS:7077 $algo hdfs://$MASTERS:9000/$data --numIter=$iter --numEPart=$epart ; } 2> $file
#   { $tc -f "TOTAL: %e seconds" $command $class spark://$MASTERS:7077 $algo hdfs://$MASTERS:9000/$data --numIter=$iter --numEPart=$epart --partStrategy=$partstrat; } 2>> $file
#   echo "" >> $file
#   counter=$(( $counter + 1 ))
#   # restart the cluster because my fucking slaves keep dying
#   ~/rebuild-graphx -no
# done
# 
# iter=20
# counter=0
# partstrat="EdgePartition1D"
# while [ $counter -lt $numtrials ]; do
#   # echo "NEW RUN!!!!!" >> $file
#   echo $command $class spark://$MASTERS:7077 $algo hdfs://$MASTERS:9000/$data --numIter=$iter --numEPart=$epart --partStrategy=$partstrat >> $file
#   #{ time %e $command $class spark://$MASTERS:7077 $algo hdfs://$MASTERS:9000/$data --numIter=$iter --numEPart=$epart ; } 2> $file
#   { $tc -f "TOTAL: %e seconds" $command $class spark://$MASTERS:7077 $algo hdfs://$MASTERS:9000/$data --numIter=$iter --numEPart=$epart --partStrategy=$partstrat; } 2>> $file
#   echo "" >> $file
#   counter=$(( $counter + 1 ))
#   # restart the cluster because my fucking slaves keep dying
#   ~/rebuild-graphx -no
# done
# 
# iter=20
# counter=0
# partstrat="EdgePartition2D"
# while [ $counter -lt $numtrials ]; do
#   # echo "NEW RUN!!!!!" >> $file
#   echo $command $class spark://$MASTERS:7077 $algo hdfs://$MASTERS:9000/$data --numIter=$iter --numEPart=$epart --partStrategy=$partstrat >> $file
#   #{ time %e $command $class spark://$MASTERS:7077 $algo hdfs://$MASTERS:9000/$data --numIter=$iter --numEPart=$epart ; } 2> $file
#   { $tc -f "TOTAL: %e seconds" $command $class spark://$MASTERS:7077 $algo hdfs://$MASTERS:9000/$data --numIter=$iter --numEPart=$epart --partStrategy=$partstrat; } 2>> $file
#   echo "" >> $file
#   counter=$(( $counter + 1 ))
#   # restart the cluster because my fucking slaves keep dying
#   ~/rebuild-graphx -no
# done



# # 40 iterations pagerank
# iter=40
# counter=0
# while [ $counter -lt $numtrials ]; do
#   # echo "NEW RUN!!!!!" >> $file
#   echo $command $class spark://$MASTERS:7077 $algo hdfs://$MASTERS:9000/$data --numIter=$iter --numEPart=$epart >> $file
#   #{ time %e $command $class spark://$MASTERS:7077 $algo hdfs://$MASTERS:9000/$data --numIter=$iter --numEPart=$epart ; } 2> $file
#   { $tc -f "TOTAL: %e seconds" $command $class spark://$MASTERS:7077 $algo hdfs://$MASTERS:9000/$data --numIter=$iter --numEPart=$epart; } 2>> $file
#   echo "" >> $file
#   counter=$(( $counter + 1 ))
# done






#time ./run-example org.apache.spark.graph.Analytics spark://$MASTER:7077 pagerank hdfs://$MASTER:9000/soc-LiveJournal1.txt --numIter=2 --numEPart=128


